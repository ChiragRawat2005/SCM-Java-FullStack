<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
  th:replace="~{base :: parent(~{::#content},~{::title},~{::script})}">

<head>
  <title th:text="${loggedInUser != null ? loggedInUser.name + ' | Profile' : 'Profile'}">
    Profile
  </title>
</head>

<body>

  <div id="content" class="pt-20 sm:ml-64 lg:ml-80 px-6">

    <div class="flex justify-center">
      <div class="w-full max-w-2xl xl:max-w-3xl">

        <!-- ================= PROFILE CARD ================= -->
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-xl p-6 mb-8">

          <!-- Flash Message -->
          <div th:replace="~{message :: messagebox}"></div>

          <!-- Avatar Section -->
          <div class="flex flex-col items-center gap-4">

            <div class="relative group cursor-pointer">

              <!-- Profile Image -->
              <img id="profilePreview"
                th:src="${loggedInUser != null && loggedInUser.profilePic != null ? loggedInUser.profilePic : '/images/default_user.png'}"
                class="w-32 h-32 rounded-full object-cover ring-4 ring-blue-500/30 dark:ring-blue-400/30 shadow-lg"
                alt="Profile" />

              <!-- Edit Icon -->
              <div onclick="document.getElementById('profilePicInput').click()" class="absolute bottom-1 right-1
                        bg-blue-600 hover:bg-blue-700
                        text-white p-2 rounded-full shadow-lg
                        transition">
                <i class="fa-solid fa-pen text-sm"></i>
              </div>
            </div>

            <!-- Name -->
            <h2 class="text-2xl font-extrabold text-gray-900 dark:text-white"
              th:text="${loggedInUser != null ? loggedInUser.name : 'User'}">
            </h2>

            <!-- Email -->
            <p class="text-gray-500 dark:text-gray-400" th:text="${loggedInUser != null ? loggedInUser.email : ''}">
            </p>

          </div>
        </div>

        <!-- ================= UPDATE FORM ================= -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">

          <form th:action="@{/profile/update}" th:object="${userForm}" method="post" enctype="multipart/form-data"
            class="space-y-5">

            <!-- Hidden file input -->
            <input type="file" id="profilePicInput" th:field="*{profilePic}" accept="image/jpeg,image/png,image/webp"
              class="hidden" onchange="if(validateImageType(this)) {validateImageSize(this);}">

            <!-- ================= IMAGE SIZE POPUP ================= -->
            <div id="imageSizePopup" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">

              <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg
                        max-w-sm w-full p-6 text-center">

                <div class="flex justify-center mb-3">
                  <div class="w-12 h-12 flex items-center justify-center
                            rounded-full bg-red-100 text-red-600">
                    <i class="fa-solid fa-circle-exclamation text-xl"></i>
                  </div>
                </div>

                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                  Image Too Large
                </h3>

                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                  Image size must be less than <strong>2 MB</strong>.
                </p>

                <button type="button" onclick="closeImagePopup()" class="px-5 py-2 text-sm font-medium text-white
                             bg-red-600 rounded-lg hover:bg-red-700">
                  OK
                </button>

              </div>
            </div>

            <!-- ================= IMAGE TYPE POPUP ================= -->
            <div id="imageTypePopup" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">

              <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg
                          max-w-sm w-full p-6 text-center">

                <div class="flex justify-center mb-3">
                  <div class="w-12 h-12 flex items-center justify-center
                              rounded-full bg-red-100 text-red-600">
                    <i class="fa-solid fa-image text-xl"></i>
                  </div>
                </div>

                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                  Invalid Image Type
                </h3>

                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                  Only <strong>JPG, PNG, WEBP</strong> images are allowed.
                </p>

                <button type="button" onclick="closeImageTypePopup()" class="px-5 py-2 text-sm font-medium text-white
                              bg-red-600 rounded-lg hover:bg-red-700">
                  OK
                </button>

              </div>
            </div>

            <!-- Name -->
            <div>
              <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">
                Name
              </label>
              <input type="text" th:field="*{name}" class="w-full p-3 rounded-lg
                          bg-gray-50 dark:bg-gray-700
                          border border-gray-300 dark:border-gray-600
                          text-gray-900 dark:text-white" />
            </div>

            <!-- Email (readonly) -->
            <div>
              <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">
                Email
              </label>
              <input type="email" th:value="${loggedInUser != null ? loggedInUser.email : ''}" readonly class="w-full p-3 rounded-lg
                          bg-gray-100 dark:bg-gray-700
                          border border-gray-300 dark:border-gray-600
                          text-gray-500 dark:text-gray-400
                          cursor-not-allowed" />
            </div>

            <!-- Phone -->
            <div>
              <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">
                Phone
              </label>
              <input type="text" th:field="*{phone}" class="w-full p-3 rounded-lg
                          bg-gray-50 dark:bg-gray-700
                          border border-gray-300 dark:border-gray-600
                          text-gray-900 dark:text-white" />
            </div>

            <!-- Message -->
            <div>
              <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">
                About You
              </label>
              <textarea rows="4" th:field="*{message}" class="w-full p-3 rounded-lg
                             bg-gray-50 dark:bg-gray-700
                             border border-gray-300 dark:border-gray-600
                             text-gray-900 dark:text-white"></textarea>
            </div>

            <!-- Password -->
            <div>
              <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">
                New Password (optional)
              </label>

              <div class="relative">
                <input type="password" th:field="*{newPassword}" id="password" class="w-full p-3 pr-10 rounded-lg
                            bg-gray-50 dark:bg-gray-700
                            border border-gray-300 dark:border-gray-600
                            text-gray-900 dark:text-white" />

                <!-- ðŸ‘ Eye Button -->
                <button type="button" id="togglePasswordBtn" class="absolute right-3 top-1/2 -translate-y-1/2
                            text-gray-500 hover:text-gray-900
                            dark:text-gray-400 dark:hover:text-white">
                  <i class="fa-solid fa-eye"></i>
                </button>
              </div>
            </div>


            <!-- Submit -->
            <div class="pt-4">
              <button type="submit" class="w-full py-3 rounded-xl
                           bg-gradient-to-r from-blue-600 to-indigo-600
                           hover:from-blue-700 hover:to-indigo-700
                           text-white font-semibold shadow-lg">
                Update Profile
              </button>
            </div>

          </form>
        </div>

      </div>
    </div>
  </div>

  <!-- ================= SCRIPT ================= -->
  <script th:src="@{/js/admin.js}"></script>
  <script>
    console.log("Profile page loaded");
  </script>

</body>

</html>